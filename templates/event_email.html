{% extends 'base.html' %}
{% block content %}

<h2>Send Email ‚Äî {{ ev.city }}</h2>
<p><strong>{{ ev.city }}</strong>
  {% if ev.event_start %} ‚Äî {{ ev.event_start.strftime('%B %d, %Y') }}{% endif %}
</p>

<form method="post">
  <input type="hidden" id="send_mode" name="send_mode" value="all">

  <div class="field">
    <label>Subject</label>
    <input name="subject" id="subject" required placeholder="Enter subject line" class="form-control">
  </div>

  <div class="field">
    <label>Message</label>
    <textarea id="body" name="body" rows="10" placeholder="Write your message here..."></textarea>
  </div>

  <div style="margin-top:12px;">
    <button class="btn btn-primary" type="submit">Send from App</button>
    <button class="btn btn-outline-secondary" type="button" id="send-test">Send Test to Myself</button>
    <a href="{{ url_for('admin_events') }}" class="btn btn-secondary">Cancel</a>
  </div>
</form>

<hr>

<h4>Recipients ({{ people|length }})</h4>
{% if people and people|length %}
  {% set all_emails = people | map(attribute='email') | select('string') | join(',') %}
  <div style="margin-bottom:10px;">
    <a href="mailto:?bcc={{ all_emails | urlencode }}"
       class="btn btn-outline-primary btn-sm">
       ‚úâÔ∏è Open in My Email App (BCC all staff)
    </a>
  </div>
  <ul>
    {% for p in people %}
      <li>{{ p.name }} ‚Äî {{ p.email }}</li>
    {% endfor %}
  </ul>
{% else %}
  <p><em>No staff emails found for this event.</em></p>
{% endif %}

<hr>

<h3>üì¨ Live Preview</h3>
<div id="email-preview" style="
  border: 1px solid #ccc;
  padding: 16px;
  border-radius: 8px;
  background: #f9f9f9;
  font-family: Arial, sans-serif;
  line-height: 1.5;
  min-height: 200px;
  white-space: pre-wrap;
">
  <em>Start typing your message above to see the preview...</em>
</div>

<!-- Trumbowyg WYSIWYG Editor -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/ui/trumbowyg.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/trumbowyg.min.js"></script>

<script>
  $(function() {
    // Initialize Trumbowyg
    $('#body').trumbowyg({
      btns: [
        ['bold', 'italic', 'underline'],
        ['unorderedList', 'orderedList'],
        ['link'],
        ['removeformat']
      ],
      autogrow: true
    });

    // Live preview updates
    $('#body').on('tbwchange keyup', function() {
      const content = $('#body').trumbowyg('html');
      document.getElementById('email-preview').innerHTML =
        content || '<em>Start typing your message above to see the preview...</em>';
    });

    // Handle test email button
    $('#send-test').on('click', function() {
      $('#send_mode').val('test');
      $(this).closest('form').submit();
    });
  });
</script>

{% endblock %}

{% extends 'base.html' %}
{% block content %}
<h1>Lodging — {{ ev.city }}</h1>

{% if target_state %}
  <h3>Clone a hotel in {{ target_state }}</h3>
  <form method="post" class="mb-3">
    <input type="hidden" name="action" value="clone_hotel">
    <select name="src_hotel_id" required>
      <option value="">— Select existing hotel in {{ target_state }} —</option>
      {% for h in same_state_hotels %}
        <option value="{{ h.id }}">{{ h.name }} — {{ h.address }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-outline-primary btn-sm">Clone</button>
  </form>
{% else %}
  <p><em>Tip:</em> Set “State” on a hotel to enable the clone picker.</p>
{% endif %}

<h3>Add a hotel to this event</h3>
<form method="post" class="mb-4">
  <input type="hidden" name="action" value="add_hotel">
  <div><label>Name <input name="name" required></label></div>
  <div><label>State (2-letter) <input name="state" maxlength="2" placeholder="NJ"></label></div>
  <div><label>Address <input name="address"></label></div>
  <div><label>Phone <input name="phone"></label></div>
  <div><label>Notes <input name="notes"></label></div>
  <button class="btn btn-primary btn-sm">Add Hotel</button>
</form>

<h3>Hotels for this event</h3>
{% for h in hotels %}
  <div class="card" style="padding:12px; margin-bottom:12px;">
    <div><strong>{{ h.name }}</strong>{% if h.state %} ({{ h.state }}){% endif %}</div>
    <div>
      {% if h.address %}{{ h.address }}{% endif %}
      {% if h.phone %}{% if h.address %} — {% endif %}{{ h.phone }}{% endif %}
    </div>
    {% if h.notes %}<div><em>{{ h.notes }}</em></div>{% endif %}

    <h4 style="margin-top:10px;">Rooms</h4>
    {% if h.rooms and h.rooms|length %}
      <table class="table table-sm">
        <thead><tr><th>Room</th><th>Check-in</th><th>Check-out</th><th>Conf #</th><th>Occupants</th></tr></thead>
        <tbody>
          {% for r in h.rooms %}
            <tr>
              <td>{{ r.room_number or '-' }}</td>
              <td>{{ r.check_in or '' }}</td>
              <td>{{ r.check_out or '' }}</td>
              <td>{{ r.confirmation or '' }}</td>
              <td>
                {% set names = [] %}
                {% if r.occupants %}
                  {% for rm in r.occupants %}
                    {% if rm.person and rm.person.name %}
                      {% set _ = names.append(rm.person.name) %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {{ names|join(', ') if names else '—' }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No rooms yet.</p>
    {% endif %}

    <form method="post" class="mt-2">
      <input type="hidden" name="action" value="add_room">
      <input type="hidden" name="hotel_id" value="{{ h.id }}">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <input name="room_number" placeholder="Room #">
        <input type="date" name="check_in" placeholder="Check-in">
        <input type="date" name="check_out" placeholder="Check-out">
        <input name="confirmation" placeholder="Conf #">
        <button class="btn btn-outline-secondary btn-sm">Add Room</button>
      </div>
    </form>

    <form method="post" class="mt-2">
      <input type="hidden" name="action" value="assign_roommates">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <select name="room_id" required>
          <option value="">— Select room —</option>
          {% for r in h.rooms %}
            <option value="{{ r.id }}">Room {{ r.room_number or r.id }}</option>
          {% endfor %}
        </select>

        <select name="person1">
          <option value="">— Person 1 —</option>
          {% for p in people %}
            <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>

        <select name="person2">
          <option value="">— Person 2 —</option>
          {% for p in people %}
            <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>

        <button class="btn btn-outline-secondary btn-sm">Save Occupants</button>
      </div>
    </form>
  </div>
{% endfor %}
{% endblock %}

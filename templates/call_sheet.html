{% extends 'base.html' %}
{% block content %}
<style>
  .cs-container { max-width: 1100px; margin: 0 auto; }
  .cs-header { text-align:center; margin-bottom:12px; }
  .cs-sub { color:#6b7280; }
  .grid2 { display:grid; grid-template-columns: 200px 1fr; gap:8px; }
  .grid2 .label { background:#f7f7f9; padding:6px 8px; font-weight:600; border:1px solid #e5e7eb; }
  .grid2 .val { padding:6px 8px; border:1px solid #e5e7eb; }
  .h2 { font-size:1.1rem; font-weight:700; margin:18px 0 8px; }
  .note-box { border:1px solid #e5e7eb; padding:10px; border-radius:8px; background:#fafafa; white-space:pre-wrap; }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { border:1px solid #bababa; padding:8px; vertical-align:top; }
  .table thead th { background:#f7f7f9; }
  .btn-print { float:right; margin: 6px 0 0 0; }
  .welcome { margin:10px 0 8px; }
  .logo { display:block; margin:0 auto 6px; height:64px; }
  .setup-row { background: #fff6e5; }

  /* Alternating row colors for the Assignments table */
  .assign-table tbody tr:nth-child(odd) {
    background-color: #ffffff;
  }
  .assign-table tbody tr:nth-child(even) {
    background-color: #f5f5f5;
  }
{% if show_unpublished_banner %}
<div style="background:#fff3cd; color:#856404; border:1px solid #ffeeba; padding:10px; margin-bottom:10px; border-radius:6px;">
  ‚ö†Ô∏è This call sheet is a draft and has not yet been officially published.
</div>
{% endif %}
  @media print {
    .no-print { display: none; }
    .assign-table tbody tr:nth-child(even) {
      background-color: #efefef !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }

  /* Gold button styling */
  .btn-outline-primary {
    background: linear-gradient(90deg, #bfa34d, #f0e3a3);
    color: black !important;
    border: none;
    font-weight: 600;
    border-radius: 8px;
    padding: 6px 12px;
    transition: all 0.2s ease-in-out;
  }
  .btn-outline-primary:hover {
    background: linear-gradient(90deg, #e6cb69, #fff3b0);
    transform: scale(1.03);
  }
</style>

<div class="cs-container">
  <div class="no-print" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <div>
      <a href="{{ url_for('admin_call_sheet_pdf', eid=ev.id) }}"
         class="btn btn-sm btn-outline-primary"
         target="_blank">
        üìÑ Download PDF
      </a>
    </div>
    <button class="btn btn-sm btn-outline btn-print" onclick="window.print()">üñ® Print</button>
  </div>

  {% set logo = url_for('static', filename='OSA_Logo_Silver_Gold.png') %}
  <img class="logo" src="{{ logo }}" alt="On Stage America">

  <div class="cs-header">
    <h1 style="margin:0;">Call Sheet ‚Äî {{ ev.city }}</h1>
    <div class="cs-sub">
      {% if ev.date %} {{ ev.date.strftime('%B %d, %Y - %I:%M %p') }} {% else %} &nbsp; {% endif %}
    </div>
  </div>

  <div class="welcome">
    <strong>Welcome</strong><br>
    Thank you for being part of the On Stage America team. We expect the team to be professional and dress as described in the dress code. Backstage Manager must be constantly vigilant backstage (and keep an eye on stage), greeting kids and teachers as they approach. Other backstage staff should assist the Backstage Manager during heavy loads. Judges: please be careful with comments‚Äîmany studios play them directly to the kids. Absolutely no foul language; do not discuss dancers, studios, or routines within earshot of others (use the staff room or hotel, and remember walls can be thin).
  </div>

  <!-- Event Info -->
  <div class="h2">Event Information</div>
  <div class="grid2">
    <div class="label">City</div><div class="val">{{ ev.city or '‚Äî' }}</div>
    <div class="label">Main Start</div><div class="val">{{ ev.event_start.strftime('%B %d, %Y - %I:%M %p') if ev.event_start else '‚Äî' }}</div>
    <div class="label">Setup</div><div class="val">{{ ev.setup_start.strftime('%B %d, %Y - %I:%M %p') if ev.setup_start else '‚Äî' }}</div>
    <div class="label">End</div><div class="val">{{ ev.event_end.strftime('%B %d, %Y - %I:%M %p') if ev.event_end else '‚Äî' }}</div>
    <div class="label">Venue</div><div class="val">{{ ev.venue or '‚Äî' }}</div>
    {% if ev.hotel %}<div class="label">Hotel</div><div class="val">{{ ev.hotel }}</div>{% endif %}
    <div class="label">Coordinator</div>
    <div class="val">
      {% if ev.coordinator_name %}{{ ev.coordinator_name }}{% else %}‚Äî{% endif %}
      {% if ev.coordinator_phone %} &nbsp; | &nbsp; {{ ev.coordinator_phone }}{% endif %}
    </div>
    {% if ev.dress_code %}
      <div class="label">Dress Code</div><div class="val">{{ ev.dress_code }}</div>
    {% endif %}
  </div>

  <!-- Daily Schedule -->
  {% if day_rows and day_rows|length %}
  <div class="h2">Daily Schedule</div>
  <table class="table">
    <thead>
      <tr>
        <th>Day Start</th>
        <th>Setup</th>
        <th>Staff Arrival</th>
        <th>Judges Arrival</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      {% for d in day_rows %}
        {% if d.setup_only %}
          <tr style="background:#fff8e1;">
            <td>{{ d.start.strftime('%B %d, %Y - %I:%M %p') if d.start else '' }}</td>
            <td>{{ d.setup.strftime('%B %d, %Y - %I:%M %p') if d.setup else '' }}</td>
            <td>{{ d.staff.strftime('%B %d, %Y - %I:%M %p') if d.staff else '' }}</td>
            <td style="background-color: #FFCCCC;"><em>Setup Only ‚Äî No Judges Required</em></td>
            <td>{{ d.notes or '' }}</td>
          </tr>
        {% else %}
          <tr>
            <td>{{ d.start.strftime('%B %d, %Y - %I:%M %p') if d.start else '' }}</td>
            <td>{{ d.setup.strftime('%B %d, %Y - %I:%M %p') if d.setup else '' }}</td>
            <td>{{ d.staff.strftime('%B %d, %Y - %I:%M %p') if d.staff else '' }}</td>
            <td>{{ d.judges.strftime('%B %d, %Y - %I:%M %p') if d.judges else '' }}</td>
            <td>{{ d.notes or '' }}</td>
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  <!-- Staff Assignments -->
  <div class="h2">Assignments</div>
  <table class="assign-table">
    <colgroup>
      <col style="width:12%">
      <col style="width:22%">
      <col style="width:15%">
      <col style="width:25%">
      <col style="width:auto">
    </colgroup>
    <thead>
      <tr>
        <th>Position</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Transport / Notes</th>
      </tr>
    </thead>
    <tbody>
      {% for a in rows %}
        <tr>
          <td class="assign-pos">{{ a.position.name if a.position else '' }}</td>
          <td class="assign-name">{{ a.person.name if a.person else '' }}</td>
          <td class="assign-phone">{{ a.person.phone if a.person and a.person.phone else '' }}</td>
          <td class="assign-email">{{ a.person.email if a.person and a.person.email else '' }}</td>
          <td class="assign-notes">
            {%- set lines = [] -%}
            {%- if a.transport_mode -%}{%- set _ = lines.append('Mode: ' ~ a.transport_mode) -%}{%- endif -%}
            {%- if a.arrival_ts -%}{%- set _ = lines.append('Arrival: ' ~ a.arrival_ts.strftime('%B %d, %Y %I:%M %p')) -%}{%- endif -%}
            {%- if a.transport_booking -%}{%- set _ = lines.append('Booking: ' ~ a.transport_booking) -%}{%- endif -%}
            {%- if a.transport_notes -%}{%- set _ = lines.append(a.transport_notes) -%}{%- endif -%}
            {{- lines|join('<br>')|safe -}}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Hotels -->
  <div class="h2">Hotel & Room Assignments</div>
  {% if hotels %}
    {% for h in hotels %}
      <div style="margin:8px 0;"><strong>{{ h.name }}</strong></div>
      {% if h.address or h.phone %}
        <div class="cs-sub" style="margin-bottom:6px;">
          {{ h.address or '' }}{% if h.address and h.phone %} ‚Äî {% endif %}{{ h.phone or '' }}
        </div>
      {% endif %}
      {% if h.notes %}<div style="margin-bottom:6px;"><em>{{ h.notes }}</em></div>{% endif %}
      {% if h.rooms %}
        <table class="table" style="margin-bottom:12px;">
          <thead><tr><th>Room</th><th>Occupants</th><th>Check-in</th><th>Check-out</th><th>Confirmation</th></tr></thead>
          <tbody>
            {% for r in h.rooms %}
              <tr>
                <td>{{ r.room_number or '-' }}</td>
                <td>
                  {% set names = [] %}
                  {% for rm in r.occupants %}
                    {% if rm.person %}{% set _ = names.append(rm.person.name) %}{% endif %}
                  {% endfor %}
                  {{ names|join(', ') if names else '‚Äî' }}
                </td>
                <td>{{ r.check_in.strftime('%B %d, %Y') if r.check_in else '' }}</td>
                <td>{{ r.check_out.strftime('%B %d, %Y') if r.check_out else '' }}</td>
                <td>{{ r.confirmation or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endfor %}
  {% else %}
    <div class="cs-sub">No hotel assignments yet.</div>
  {% endif %}

  <!-- Attachments -->
  {% if ev.attachments %}
    <hr><h3>Event Files & Attachments</h3>
    <ul>
      {% for att in ev.attachments %}
        {% if att.visibility == 'public' and ev.call_sheet_published %}
          <li><a href="{{ url_for('download_attachment', aid=att.id) }}">{{ att.description or att.filename }}</a></li>
        {% elif att.visibility == 'staff' and current_user.is_authenticated %}
          <li><a href="{{ url_for('download_attachment', aid=att.id) }}">{{ att.description or att.filename }}</a> (Staff only)</li>
        {% endif %}
      {% endfor %}
    </ul>
  {% endif %}

  <!-- Bottom Notes -->
  <div class="h2">Notes</div>
  <div class="note-box">{{ ev.notes or '‚Äî' }}</div>
</div>
{% endblock %}

{% extends 'base.html' %}
{% block content %}
<style>
  .cs-container { max-width: 1100px; margin: 0 auto; }
  .cs-header { text-align:center; margin-bottom:12px; }
  .cs-sub { color:#6b7280; }
  .grid2 { display:grid; grid-template-columns: 200px 1fr; gap:8px; }
  .grid2 .label { background:#f7f7f9; padding:6px 8px; font-weight:600; border:1px solid #e5e7eb; }
  .grid2 .val { padding:6px 8px; border:1px solid #e5e7eb; }
  .h2 { font-size:1.1rem; font-weight:700; margin:18px 0 8px; }
  .note-box { border:1px solid #e5e7eb; padding:10px; border-radius:8px; background:#fafafa; white-space:pre-wrap; }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { border:1px solid #e5e7eb; padding:8px; vertical-align:top; }
  .table thead th { background:#f7f7f9; }
  .btn-print { float:right; margin: 6px 0 0 0; }
  .welcome { margin:10px 0 8px; }
  .logo { display:block; margin:0 auto 6px; height:64px; }
  @media print {
    .no-print { display:none; }
    .btn-print { display:none; }
    body { color:#000; }
  }
</style>

<div class="cs-container">
  <div class="no-print">
    <button class="btn btn-sm btn-outline btn-print" onclick="window.print()">Print</button>
  </div>

  {% set logo = url_for('static', filename='OSA_Logo_Silver_Gold.png') %}
  <img class="logo" src="{{ logo }}" alt="On Stage America">

  <div class="cs-header">
    <h1 style="margin:0;">Call Sheet — {{ ev.city }}</h1>
    <div class="cs-sub">
      {% if ev.date %} {{ ev.date.strftime('%B %d, %Y - %I:%M %p') }} {% else %} &nbsp; {% endif %}
    </div>
  </div>

  <div class="welcome">
    <strong>Welcome</strong><br>
    Thank you for being part of the On Stage America team. We expect the team to be professional and dress as described in the dress code. Backstage Manager must be constantly vigilant backstage (and keep an eye on stage), greeting kids and teachers as they approach. Other backstage staff should assist the Backstage Manager during heavy loads. Judges: please be careful with comments—many studios play them directly to the kids. Absolutely no foul language; do not discuss dancers, studios, or routines within earshot of others (use the staff room or hotel, and remember walls can be thin).
  </div>

  <!-- Top info -->
  <div class="h2">Event Information</div>
  <div class="grid2">
    <div class="label">City</div><div class="val">{{ ev.city or '—' }}</div>
    <div class="label">Main Start</div><div class="val">{{ ev.event_start.strftime('%B %d, %Y - %I:%M %p') if ev.event_start else '—' }}</div>
    <div class="label">Setup</div><div class="val">{{ ev.setup_start.strftime('%B %d, %Y - %I:%M %p') if ev.setup_start else '—' }}</div>
    <div class="label">End</div><div class="val">{{ ev.event_end.strftime('%B %d, %Y - %I:%M %p') if ev.event_end else '—' }}</div>
    <div class="label">Venue</div><div class="val">{{ ev.venue or '—' }}</div>
    {% if ev.hotel %}<div class="label">Hotel</div><div class="val">{{ ev.hotel }}</div>{% endif %}
    <div class="label">Coordinator</div>
    <div class="val">
      {% if ev.coordinator_name %}{{ ev.coordinator_name }}{% else %}—{% endif %}
      {% if ev.coordinator_phone %} &nbsp; | &nbsp; {{ ev.coordinator_phone }}{% endif %}
    </div>
    {% if ev.dress_code %}
      <div class="label">Dress Code</div><div class="val">{{ ev.dress_code }}</div>
    {% endif %}
  </div>

  <!-- Multi-day schedule (if any) -->
  {% if day_rows and day_rows|length %}
    <div class="h2">Daily Schedule</div>
    <table class="table">
      <thead>
        <tr>
          <th>Day Start</th>
          <th>Setup</th>
          <th>Staff Arrival</th>
          <th>Judges Arrival</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for d in day_rows %}
          <tr>
            <td>{{ d.start.strftime('%B %d, %Y - %I:%M %p') if d.start else '' }}</td>
            <td>{{ d.setup.strftime('%B %d, %Y - %I:%M %p') if d.setup else '' }}</td>
            <td>{{ d.staff.strftime('%B %d, %Y - %I:%M %p') if d.staff else '' }}</td>
            <td>{{ d.judges.strftime('%B %d, %Y - %I:%M %p') if d.judges else '' }}</td>
            <td>{{ d.notes }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- Assignments -->
 <style>
  /* Call-sheet table tuning */
  .assign-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed; /* predictable column widths */
  }
  .assign-table th,
  .assign-table td {
    border: 1px solid #ddd;
    padding: 8px;
    vertical-align: top;
  }
  .assign-table thead th {
    background: #f3f5f7;
    font-weight: 700;
    text-align: left;
  }
  .assign-pos { font-weight: 700; }                 /* bold Position */
  .assign-name { font-weight: 600; }                /* slightly stronger */
  .assign-phone, .assign-email { white-space: normal; word-break: break-word; }
  .assign-notes {
    white-space: pre-wrap;                          /* keep newlines */
    word-break: break-word;                         /* wrap long booking codes/urls/emails */
  }

  /* Responsive niceties */
  @media (max-width: 800px) {
    .assign-table { table-layout: auto; }
  }
</style>

<table class="assign-table">
  <colgroup>
    <!-- Tune widths: make Name/Phone/Email wider -->
    <col style="width:16%">   <!-- Position -->
    <col style="width:24%">   <!-- Name -->
    <col style="width:15%">   <!-- Phone -->
    <col style="width:25%">   <!-- Email -->
    <col style="width:auto">  <!-- Transport / Notes (flex) -->
  </colgroup>
  <thead>
    <tr>
      <th>Position</th>
      <th>Name</th>
      <th>Phone</th>
      <th>Email</th>
      <th>Transport / Notes</th>
    </tr>
  </thead>
  <tbody>
    {% for a in rows %}
      <tr>
        <td class="assign-pos">{{ a.position.name if a.position else '' }}</td>
        <td class="assign-name">
          {% if a.person %}
            {{ a.person.name }}
          {% endif %}
        </td>
        <td class="assign-phone">
          {% if a.person and a.person.phone %}{{ a.person.phone }}{% endif %}
        </td>
        <td class="assign-email">
          {% if a.person and a.person.email %}{{ a.person.email }}{% endif %}
        </td>
        <td class="assign-notes">
          {# Build a stacked multi-line block; each piece on its own line if present #}
          {% set lines = [] %}
          {% if a.transport_mode %}{% set _ = lines.append('Mode: ' ~ a.transport_mode) %}{% endif %}
          {% if a.arrival_ts %}{% set _ = lines.append('Arrival: ' ~ a.arrival_ts.strftime('%Y-%m-%d %I:%M %p')) %}{% endif %}
          {% if a.transport_booking %}{% set _ = lines.append('Booking: ' ~ a.transport_booking) %}{% endif %}
          {% if a.transport_notes %}{% set _ = lines.append(a.transport_notes) %}{% endif %}
          {{ lines|join('\n') }}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>


  <!-- Hotels & Rooms -->
  <div class="h2">Hotel & Room Assignments</div>
  {% if hotels and hotels|length %}
    {% for h in hotels %}
      <div style="margin:8px 0;"><strong>{{ h.name }}</strong></div>
      {% if h.address or h.phone %}
        <div class="cs-sub" style="margin-bottom:6px;">
          {{ h.address or '' }}{% if h.address and h.phone %} — {% endif %}{{ h.phone or '' }}
        </div>
      {% endif %}
      {% if h.notes %}<div style="margin-bottom:6px;"><em>{{ h.notes }}</em></div>{% endif %}

      {% if h.rooms and h.rooms|length %}
        <table class="table" style="margin-bottom:12px;">
          <thead>
            <tr>
              <th>Room</th>
              <th>Occupants</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>Confirmation</th>
            </tr>
          </thead>
          <tbody>
            {% for r in h.rooms %}
              <tr>
                <td>{{ r.room_number or '-' }}</td>
                <td>
                  {% set names = [] %}
                  {% for rm in r.occupants %}
                    {% if rm.person %}{% set _ = names.append(rm.person.name) %}{% endif %}
                  {% endfor %}
                  {{ names|join(', ') if names else '—' }}
                </td>
                <td>{{ r.check_in.strftime('%Y-%m-%d') if r.check_in else '' }}</td>
                <td>{{ r.check_out.strftime('%Y-%m-%d') if r.check_out else '' }}</td>
                <td>{{ r.confirmation or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="cs-sub" style="margin-bottom:10px;">No rooms added yet.</div>
      {% endif %}
    {% endfor %}
  {% else %}
    <div class="cs-sub">No hotel assignments yet.</div>
  {% endif %}

  <!-- Bottom Notes -->
  <div class="h2">Notes</div>
  <div class="note-box">{{ ev.notes or '—' }}</div>
</div>
{% endblock %}
